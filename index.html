<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AS_352 Swine Production — Flashcard Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --ok:#22c55e; --bad:#ef4444; --accent:#3b82f6; }
    html,body{height:100%}
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans'; }
    .choice.correct{outline:2px solid var(--ok); background: rgb(34 197 94 / .15)}
    .choice.wrong{outline:2px solid var(--bad); background: rgb(239 68 68 / .15)}
    .hide{display:none}
    .card{perspective:1000px}
    .flip{transform-style:preserve-3d; transition:transform .6s ease}
    .flipped{transform:rotateY(180deg)}
    .front,.back{backface-visibility:hidden}
    .back{transform:rotateY(180deg)}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-white">
  <main class="max-w-4xl mx-auto p-4 md:p-8">
    <header class="flex flex-wrap items-center justify-between gap-3">
      <h1 class="text-2xl md:text-3xl font-bold">AS_352 Flashcard Quiz</h1>
      <div class="flex items-center gap-2">
        <button id="btnImport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Import JSON</button>
        <button id="btnExport" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Export Progress</button>
        <button id="btnReset" class="px-3 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Reset</button>
      </div>
    </header>

    <section class="mt-4 bg-slate-900/80 border border-slate-800 rounded-2xl p-5 md:p-6 shadow-xl">
      <div class="flex flex-wrap items-center justify-between gap-4">
        <div class="text-sm text-slate-300"><span id="count">0</span> cards • <span id="progressText">0 / 0</span></div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <label class="flex items-center gap-2"><input id="shuffleToggle" type="checkbox" class="accent-blue-500"> Shuffle</label>
          <label class="flex items-center gap-2"><input id="autoNextToggle" type="checkbox" class="accent-blue-500" checked> Auto‑next on correct</label>
          <label class="flex items-center gap-2"><input id="soundToggle" type="checkbox" class="accent-blue-500"> Sounds</label>
        </div>
      </div>
      <div class="h-2 mt-3 bg-slate-800 rounded-full overflow-hidden">
        <div id="progressBar" class="h-full bg-blue-600" style="width:0%"></div>
      </div>

      <!-- Flashcard -->
      <div class="card mt-6">
        <div id="flip" class="flip relative bg-slate-950/70 border border-slate-800 rounded-2xl p-6">
          <div class="front">
            <div id="question" class="text-lg md:text-xl font-semibold leading-relaxed select-none"></div>
          </div>
          <div class="back absolute inset-0 p-6">
            <div class="text-base text-slate-300">Correct answer</div>
            <div id="answerText" class="text-xl font-semibold mt-2"></div>
            <div id="explain" class="text-slate-300 mt-3 text-sm"></div>
          </div>
        </div>
      </div>

      <!-- Options -->
      <div id="options" class="mt-6 grid gap-3"></div>

      <!-- Footer controls -->
      <div class="mt-6 flex flex-wrap items-center justify-between gap-3">
        <div class="text-sm text-slate-400">Score: <span id="score">0</span> correct, <span id="wrong">0</span> wrong</div>
        <div class="flex gap-2">
          <button id="prevBtn" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Prev</button>
          <button id="revealBtn" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Reveal</button>
          <button id="nextBtn" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold">Next</button>
        </div>
      </div>
    </section>

    <!-- Empty state / dataset help -->
    <section id="help" class="mt-8 bg-slate-900/60 border border-slate-800 rounded-2xl p-6">
      <h2 class="text-lg font-semibold">Dataset</h2>
      <p class="text-slate-300 mt-2">This app auto‑loads <code>as352_verified_qna_FINAL.json</code> from the same folder. Place that file next to this <code>index.html</code>. Or click <b>Import JSON</b> to load a file manually.</p>
      <p class="text-slate-400 mt-2 text-sm">Format (per item): { question, options[4], answer (0‑based), answer_text, support_1?, support_2? }</p>
    </section>

    <!-- Results / Review -->
    <section id="results" class="mt-8 hidden">
      <div class="bg-slate-900/80 border border-slate-800 rounded-2xl p-6">
        <h2 class="text-xl font-bold">Session summary</h2>
        <p class="mt-2 text-slate-300">You answered <span id="sumRight">0</span> correct and <span id="sumWrong">0</span> wrong.</p>
        <div id="review" class="mt-4 grid gap-3"></div>
        <div class="mt-4 flex gap-2">
          <button id="restartBtn" class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold">Restart</button>
          <button id="wrongOnlyBtn" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700">Study wrong only</button>
        </div>
      </div>
    </section>
  </main>

  <input id="file" type="file" accept="application/json" class="hidden" />

  <audio id="sCorrect" class="hide"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICA" type="audio/wav"></audio>
  <audio id="sWrong" class="hide"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICA" type="audio/wav"></audio>

  <script>
  const LS_KEY = 'as352_flashcards_progress_v1';
  const saveProgress = (state) => localStorage.setItem(LS_KEY, JSON.stringify(state));
  const loadProgress = () => { try { return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); } catch { return {}; } };

  let DATA = [];
  let idx = 0;
  let correct = 0, wrong = 0;
  let answered = new Map();
  let shuffledOrder = [];

  const elQ = document.getElementById('question');
  const elA = document.getElementById('answerText');
  const elExplain = document.getElementById('explain');
  const elOpts = document.getElementById('options');
  const elCount = document.getElementById('count');
  const elProgText = document.getElementById('progressText');
  const elProg = document.getElementById('progressBar');
  const elScore = document.getElementById('score');
  const elWrong = document.getElementById('wrong');
  const elFlip = document.getElementById('flip');
  const elResults = document.getElementById('results');
  const elReview = document.getElementById('review');
  const sCorrect = document.getElementById('sCorrect');
  const sWrong = document.getElementById('sWrong');

  document.getElementById('prevBtn').onclick = () => nav(-1);
  document.getElementById('nextBtn').onclick = () => nav(1);
  document.getElementById('revealBtn').onclick = () => elFlip.classList.toggle('flipped');
  document.getElementById('btnReset').onclick = resetAll;
  document.getElementById('btnImport').onclick = () => document.getElementById('file').click();
  document.getElementById('btnExport').onclick = exportProgress;
  document.getElementById('file').addEventListener('change', handleFile);

  const shuffleToggle = document.getElementById('shuffleToggle');
  const autoNextToggle = document.getElementById('autoNextToggle');
  const soundToggle = document.getElementById('soundToggle');

  function tickSounds(ok){ if(!soundToggle.checked) return; (ok ? sCorrect : sWrong).currentTime=0; (ok ? sCorrect : sWrong).play().catch(()=>{}); }

  function resetAll(){
    localStorage.removeItem(LS_KEY);
    startSession(DATA);
  }

  function exportProgress(){
    const blob = new Blob([JSON.stringify({answered:[...answered], correct, wrong, idx, order:shuffledOrder}, null, 2)], {type:'application/json'});
    const a = Object.assign(document.createElement('a'), {href: URL.createObjectURL(blob), download:'flashcard_progress.json'});
    a.click();
  }

  async function handleFile(e){
    const file = e.target.files[0]; if(!file) return;
    const text = await file.text();
    const arr = JSON.parse(text);
    if(!Array.isArray(arr)) { alert('Invalid JSON array'); return; }
    DATA = normalize(arr);
    startSession(DATA);
  }

  function normalize(arr){
    return arr.map((x,i)=>({ number: x.number ?? i+1, question: x.question?.trim() ?? '',
      options: x.options ?? [x.A, x.B, x.C, x.D].filter(Boolean),
      answer: (typeof x.answer === 'number') ? x.answer : (typeof x.correct_index==='number'? x.correct_index:0),
      answer_text: x.answer_text ?? (Array.isArray(x.options)? x.options[x.answer]:''),
      support_1: x.support_1 ?? '', support_2: x.support_2 ?? '' }));
  }

  function startSession(items){
    answered.clear(); correct = 0; wrong = 0; elResults.classList.add('hidden');
    shuffledOrder = items.map((_,i)=>i);
    if(shuffleToggle.checked) shuffledOrder.sort(()=>Math.random()-0.5);
    idx = 0;
    render();
  }

  function render(){
    const i = shuffledOrder[idx];
    const it = DATA[i];
    elQ.textContent = it.question;
    elA.textContent = it.answer_text || (it.options?.[it.answer] ?? '');
    elExplain.textContent = [it.support_1, it.support_2].filter(Boolean).join(' ');
    elFlip.classList.remove('flipped');

    elOpts.innerHTML = '';
    it.options.forEach((opt, k)=>{
      const btn = document.createElement('button');
      btn.className = 'choice w-full text-left px-4 py-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700';
      btn.innerHTML = `<span class="font-semibold mr-2">${String.fromCharCode(65+k)})</span> ${opt}`;
      btn.onclick = () => pick(k);
      elOpts.appendChild(btn);
    });

    const total = DATA.length; document.getElementById('count').textContent = total;
    const done = answered.size; document.getElementById('progressText').textContent = `${done} / ${total}`;
    document.getElementById('progressBar').style.width = Math.round((done/Math.max(1,total))*100)+'%';
    document.getElementById('score').textContent = correct; document.getElementById('wrong').textContent = wrong;

    const st = answered.get(i);
    if(st){
      [...elOpts.children].forEach((el, k)=>{
        if(k === st.picked){ el.classList.add(st.correct? 'correct':'wrong'); }
        if(k === it.answer){ el.classList.add('correct'); }
      });
    }
  }

  function pick(k){
    const i = shuffledOrder[idx];
    const it = DATA[i];
    const ok = (k === it.answer);
    answered.set(i, {picked:k, correct:ok});
    if(ok) correct++; else wrong++;

    [...elOpts.children].forEach((el, j)=>{
      el.classList.remove('correct','wrong');
      if(j === k && !ok) el.classList.add('wrong');
      if(j === it.answer) el.classList.add('correct');
    });
    document.getElementById('flip').classList.add('flipped');
    if(ok && autoNextToggle.checked){ setTimeout(()=>nav(1), 600); }
    render();
    if(answered.size === DATA.length){ showResults(); }
  }

  function nav(step){
    const n = DATA.length;
    idx = (idx + step + n) % n;
    render();
  }

  function showResults(){
    document.getElementById('results').classList.remove('hidden');
    document.getElementById('sumRight').textContent = correct;
    document.getElementById('sumWrong').textContent = wrong;
    const elReview = document.getElementById('review');
    elReview.innerHTML = '';
    shuffledOrder.forEach(i=>{
      const it = DATA[i]; const st = answered.get(i);
      const div = document.createElement('div');
      div.className = 'p-3 rounded-xl bg-slate-800/70 border border-slate-700';
      const pickTxt = st? `${String.fromCharCode(65+st.picked)}) ${it.options[st.picked]}` : '—';
      div.innerHTML = `<div class="text-sm text-slate-400 mb-1">Q${it.number}</div>
        <div class="font-semibold">${it.question}</div>
        <div class="mt-2 ${st&&st.correct?'text-green-400':'text-red-400'}">Your answer: ${pickTxt}</div>
        <div class="mt-1 text-green-300">Correct: ${String.fromCharCode(65+it.answer)}) ${it.options[it.answer]}</div>
        ${it.support_1? `<div class="mt-2 text-slate-300 text-sm">${it.support_1}</div>`:''}
        ${it.support_2? `<div class="text-slate-400 text-xs">${it.support_2}</div>`:''}`;
      elReview.appendChild(div);
    });
  }

  (async function init(){
    try {
      const res = await fetch('./as352_verified_qna_FINAL.json', {cache:'no-store'});
      if(res.ok){
        const arr = await res.json();
        DATA = normalize(arr);
        document.getElementById('help').classList.add('hidden');
        startSession(DATA);
        return;
      }
    } catch(e) { }
    DATA = [];
  })();
  </script>
</body>
</html>